# 第14章 项目配置与构建优化——从开发到生产的完整流程

## 本章目标

1. 掌握package.json依赖分类与版本管理策略(^、~、精确版本)
2. 深入理解Vite配置文件的核心选项(插件、优化、代理)
3. 学会TypeScript配置文件(tsconfig.json)的类型检查与编译选项
4. 理解环境变量管理(.env文件)在多环境部署中的作用
5. 掌握生产构建优化技巧(代码分割、Tree-shaking、压缩)

---

## 一、package.json依赖管理

### 1. 依赖分类

**完整的package.json示例**(基于chatgpt-vue3-light-mvp):

```json
{
  "name": "chatgpt-vue3-light-mvp",
  "type": "module",
  "version": "0.0.1",
  "engines": {
    "node": ">= 18.12.x",
    "pnpm": ">= 9.x"
  },
  "scripts": {
    "dev": "vite --host",
    "build": "vite build",
    "preview": "vite preview --host",
    "lint": "eslint .",
    "lint:fix": "eslint --fix ."
  },
  "dependencies": {
    "@vueuse/core": "^10.10.0",
    "axios": "1.7.2",
    "marked": "^13.0.1",
    "pinia": "^3.0.2",
    "vue": "^3.5.13",
    "vue-router": "^4.5.0",
    "naive-ui": "^2.38.2",
    "echarts": "^5.5.1",
    "dompurify": "^3.1.5"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.2.4",
    "vite": "^6.3.5",
    "typescript": "^5.8.2",
    "@types/node": "^20.14.2",
    "eslint": "^9.27.0"
  }
}
```

**依赖分类说明**:

| 字段 | 用途 | 安装命令 |
|------|------|---------|
| `dependencies` | 运行时依赖(打包到生产环境) | `pnpm add vue` |
| `devDependencies` | 开发时依赖(不打包) | `pnpm add -D vite` |
| `peerDependencies` | 宿主依赖(插件开发用) | 手动声明 |

**常见错误**:

```bash
# ✗ 错误: 把Vite放到dependencies
pnpm add vite

# ✓ 正确: Vite是构建工具,应该放到devDependencies
pnpm add -D vite
```

### 2. 版本号规则

**语义化版本(Semver)**:

```
版本号格式: MAJOR.MINOR.PATCH
示例: 3.5.13
     │ │ │
     │ │ └── Patch: 修复Bug (向下兼容)
     │ └──── Minor: 新增功能 (向下兼容)
     └────── Major: 破坏性变更 (不兼容)
```

**版本号前缀**:

| 前缀 | 含义 | 示例 | 更新规则 |
|------|------|------|---------|
| `^` | 允许Minor和Patch更新 | `^3.5.13` | 3.5.13 → 3.9.99 ✓ <br> 3.5.13 → 4.0.0 ✗ |
| `~` | 仅允许Patch更新 | `~3.5.13` | 3.5.13 → 3.5.99 ✓ <br> 3.5.13 → 3.6.0 ✗ |
| 无前缀 | 精确版本 | `3.5.13` | 仅安装3.5.13 |
| `*` | 最新版本(危险) | `*` | 总是安装最新版 |

**最佳实践**:

```json
{
  "dependencies": {
    "vue": "^3.5.13",        // ✓ 允许更新到3.x最新版
    "axios": "1.7.2",        // ✓ 锁定版本,避免破坏性变更
    "marked": "^13.0.1"      // ✓ 允许更新到13.x
  },
  "devDependencies": {
    "vite": "^6.3.5",        // ✓ 开发工具可以更新
    "typescript": "^5.8.2"   // ✓ 类型定义更新无风险
  }
}
```

### 3. 锁文件(pnpm-lock.yaml)

**为什么需要锁文件?**

**问题场景**:

```
开发环境:
package.json: "vue": "^3.5.13"
实际安装: vue@3.5.13

生产环境(3个月后):
package.json: "vue": "^3.5.13"
实际安装: vue@3.9.0 (最新版)

结果: 生产环境出现新Bug!
```

**锁文件解决方案**:

```yaml
# pnpm-lock.yaml
lockfileVersion: '6.0'

dependencies:
  vue:
    specifier: ^3.5.13
    version: 3.5.13  # ← 精确锁定版本
```

**最佳实践**:

```bash
# ✓ 提交锁文件到Git
git add pnpm-lock.yaml

# ✓ CI/CD使用pnpm install --frozen-lockfile
# 禁止自动更新依赖,确保版本一致
pnpm install --frozen-lockfile

# ✗ 不要删除锁文件
# ✗ 不要手动修改锁文件
```

---

## 二、Vite配置详解

### 1. 基础配置(vite.config.ts)

**完整配置示例**:

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  // 插件配置
  plugins: [
    vue(),
  ],

  // 路径别名
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
      '@components': resolve(__dirname, 'src/components'),
      '@utils': resolve(__dirname, 'src/utils'),
    },
  },

  // 开发服务器配置
  server: {
    host: '0.0.0.0',  // 允许局域网访问
    port: 8081,
    open: true,       // 自动打开浏览器
    proxy: {
      '/sanic': {
        target: 'http://localhost:8089',
        changeOrigin: true,
        rewrite: (path) => path,  // 保持路径不变
      },
    },
  },

  // 构建配置
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,  // 生产环境不生成sourcemap
    minify: 'terser',  // 使用terser压缩
    terserOptions: {
      compress: {
        drop_console: true,  // 删除console.log
        drop_debugger: true,
      },
    },
    rollupOptions: {
      output: {
        // 代码分割
        manualChunks: {
          vue: ['vue', 'vue-router', 'pinia'],
          naive: ['naive-ui'],
          echarts: ['echarts'],
        },
      },
    },
  },

  // CSS配置
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `@import "@/styles/variables.scss";`,
      },
    },
  },
})
```

**关键配置说明**:

1. **路径别名**: 简化import路径

```typescript
// 没有别名
import MyComponent from '../../components/MyComponent.vue'

// 使用别名
import MyComponent from '@components/MyComponent.vue'
```

2. **代理配置**: 解决跨域问题

```typescript
proxy: {
  '/sanic': {
    target: 'http://localhost:8089',
    changeOrigin: true,  // 修改请求头的origin
  },
}
```

**工作原理**:

```
浏览器请求: http://localhost:8081/sanic/user/login
    ↓
Vite代理转发: http://localhost:8089/sanic/user/login
    ↓
Sanic后端响应
```

### 2. 常用插件

**自动导入插件**(unplugin-auto-import):

```typescript
import AutoImport from 'unplugin-auto-import/vite'

export default defineConfig({
  plugins: [
    vue(),
    AutoImport({
      imports: ['vue', 'vue-router', 'pinia'],
      dts: 'src/auto-imports.d.ts',  // 生成类型声明
    }),
  ],
})
```

**效果**:

```typescript
// 之前: 需要手动import
import { ref, computed } from 'vue'
const count = ref(0)

// 之后: 自动导入
const count = ref(0)  // ref会自动导入
```

**组件自动注册**(unplugin-vue-components):

```typescript
import Components from 'unplugin-vue-components/vite'
import { NaiveUiResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    Components({
      resolvers: [NaiveUiResolver()],
      dts: 'src/components.d.ts',
    }),
  ],
})
```

**效果**:

```vue
<!-- 之前: 需要手动import -->
<script setup>
import { NButton } from 'naive-ui'
</script>

<template>
  <NButton>点击</NButton>
</template>

<!-- 之后: 自动注册 -->
<template>
  <NButton>点击</NButton>  <!-- 自动导入 -->
</template>
```

---

## 三、TypeScript配置

### 1. tsconfig.json详解

**完整配置示例**:

```json
{
  "compilerOptions": {
    // 目标ES版本
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],

    // 模块解析
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "allowImportingTsExtensions": true,

    // 严格模式
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    // 类型检查
    "skipLibCheck": true,
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,

    // 输出配置
    "declaration": true,
    "declarationDir": "./types",
    "sourceMap": true,

    // 路径映射(需与vite.config.ts一致)
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"]
    },

    // Vue支持
    "jsx": "preserve",
    "jsxImportSource": "vue"
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.d.ts",
    "src/**/*.tsx",
    "src/**/*.vue"
  ],
  "exclude": [
    "node_modules",
    "dist"
  ]
}
```

**关键选项说明**:

| 选项 | 作用 | 推荐值 |
|------|------|-------|
| `strict` | 启用所有严格类型检查 | `true` |
| `noUnusedLocals` | 禁止未使用的变量 | `true` |
| `skipLibCheck` | 跳过.d.ts文件检查(加速编译) | `true` |
| `moduleResolution` | 模块解析策略 | `bundler`(Vite用) |

### 2. 类型声明文件

**全局类型声明**(src/types/global.d.ts):

```typescript
// 扩展Window对象
interface Window {
  __APP_VERSION__: string
}

// 声明.vue文件模块
declare module '*.vue' {
  import { DefineComponent } from 'vue'
  const component: DefineComponent<{}, {}, any>
  export default component
}

// 声明环境变量
interface ImportMetaEnv {
  readonly VITE_API_BASE_URL: string
  readonly VITE_APP_TITLE: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

**组件Props类型定义**:

```typescript
// components/ChatMessage.vue
<script setup lang="ts">
interface Props {
  content: string
  sender: 'user' | 'ai'
  timestamp?: number
}

const props = defineProps<Props>()
// 现在props有完整的类型提示!
</script>
```

---

## 四、环境变量管理

### 1. .env文件配置

**多环境配置**:

```bash
项目根目录/
├── .env                # 所有环境共享
├── .env.development    # 开发环境(pnpm dev)
├── .env.production     # 生产环境(pnpm build)
└── .env.test           # 测试环境
```

**.env.development**:

```bash
# Vite环境变量必须以VITE_开头
VITE_API_BASE_URL=http://localhost:8089
VITE_APP_TITLE=智能问数系统(开发)
VITE_ENABLE_MOCK=true
```

**.env.production**:

```bash
VITE_API_BASE_URL=https://api.example.com
VITE_APP_TITLE=智能问数系统
VITE_ENABLE_MOCK=false
```

### 2. 使用环境变量

**在代码中访问**:

```typescript
// main.ts
console.log(import.meta.env.VITE_API_BASE_URL)  // http://localhost:8089

// 判断环境
if (import.meta.env.DEV) {
  console.log('开发环境')
}

if (import.meta.env.PROD) {
  console.log('生产环境')
}
```

**在HTML中使用**:

```html
<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>%VITE_APP_TITLE%</title>
</head>
</html>
```

**类型安全**:

```typescript
// src/types/env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_BASE_URL: string
  readonly VITE_APP_TITLE: string
  readonly VITE_ENABLE_MOCK: string
}
```

---

## 五、生产构建优化

### 1. 代码分割(Code Splitting)

**配置manualChunks**:

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          // 第三方库单独打包
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'ui-vendor': ['naive-ui'],
          'chart-vendor': ['echarts'],
          'utils-vendor': ['axios', 'marked', 'dompurify'],
        },
      },
    },
  },
})
```

**效果对比**:

```
# 不分割(默认)
dist/assets/index-abc123.js  (1.2MB)

# 分割后
dist/assets/vue-vendor-def456.js    (200KB) ← 浏览器缓存
dist/assets/ui-vendor-ghi789.js     (300KB) ← 浏览器缓存
dist/assets/chart-vendor-jkl012.js  (500KB) ← 浏览器缓存
dist/assets/index-mno345.js         (200KB) ← 业务代码(频繁变更)
```

**优势**:

- 第三方库变化少,浏览器缓存命中率高
- 业务代码变更不影响vendor文件,用户无需重新下载全部JS

### 2. Tree-shaking(摇树优化)

**原理**: 移除未使用的代码

**示例**:

```typescript
// utils.ts
export const add = (a, b) => a + b
export const subtract = (a, b) => a - b
export const multiply = (a, b) => a * b

// main.ts
import { add } from './utils'
console.log(add(1, 2))

// 打包后utils.ts仅包含add函数,subtract和multiply被删除
```

**最佳实践**:

```typescript
// ✓ 使用ES6模块(支持Tree-shaking)
import { debounce } from 'lodash-es'

// ✗ 使用CommonJS(不支持Tree-shaking)
const _ = require('lodash')
```

### 3. 资源优化

**图片压缩**(vite-plugin-imagemin):

```typescript
import viteImagemin from 'vite-plugin-imagemin'

export default defineConfig({
  plugins: [
    viteImagemin({
      gifsicle: { optimizationLevel: 7 },
      optipng: { optimizationLevel: 7 },
      mozjpeg: { quality: 80 },
      svgo: { plugins: [{ removeViewBox: false }] },
    }),
  ],
})
```

**Gzip压缩**(vite-plugin-compression):

```typescript
import viteCompression from 'vite-plugin-compression'

export default defineConfig({
  plugins: [
    viteCompression({
      algorithm: 'gzip',
      ext: '.gz',
      threshold: 10240,  // 10KB以上才压缩
    }),
  ],
})
```

**效果**:

```
index.js        (200KB)
index.js.gz     (50KB)  ← Nginx自动使用.gz文件

传输大小减少75%!
```

---

## 六、构建分析与优化

### 1. 打包分析

**使用rollup-plugin-visualizer**:

```typescript
import { visualizer } from 'rollup-plugin-visualizer'

export default defineConfig({
  plugins: [
    visualizer({
      open: true,  // 自动打开分析页面
      filename: 'stats.html',
      gzipSize: true,
    }),
  ],
})
```

**执行构建**:

```bash
pnpm build
# 自动打开stats.html,可视化展示各模块大小
```

**分析结果示例**:

```
├── vue-vendor (200KB)
│   ├── vue (120KB)
│   └── vue-router (80KB)
├── ui-vendor (300KB)
│   └── naive-ui (300KB)  ← 最大的依赖!
└── index (200KB)
```

**优化方案**:

- Naive UI太大 → 改用按需引入
- 某个工具库未使用 → 删除import

### 2. 构建性能优化

**开启多线程编译**:

```typescript
export default defineConfig({
  build: {
    minify: 'esbuild',  // 使用esbuild(比terser快20倍)
  },
})
```

**缓存优化**:

```bash
# 使用pnpm的存储机制
pnpm config set store-dir ~/.pnpm-store

# 清理缓存
pnpm store prune
```

---

## 七、常见配置问题

### 1. 路径别名不生效

**问题**: `import '@/utils/xxx'` 报错找不到模块

**原因**: vite.config.ts和tsconfig.json配置不一致

**解决**:

```typescript
// vite.config.ts
resolve: {
  alias: {
    '@': resolve(__dirname, 'src'),
  },
}

// tsconfig.json
"baseUrl": ".",
"paths": {
  "@/*": ["src/*"]  // 保持一致!
}
```

### 2. 开发环境CORS错误

**问题**: `Access-Control-Allow-Origin missing`

**解决**: 配置Vite代理

```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://backend.com',
      changeOrigin: true,  // 关键!修改请求头origin
    },
  },
}
```

### 3. 生产构建内存溢出

**问题**: `FATAL ERROR: Reached heap limit`

**解决**: 增加Node.js内存限制

```json
// package.json
{
  "scripts": {
    "build": "NODE_OPTIONS=--max-old-space-size=4096 vite build"
  }
}
```

---

## 八、本章小结

### 1. 配置文件清单

```
package.json        → 依赖管理
vite.config.ts      → Vite配置
tsconfig.json       → TypeScript配置
.env.development    → 开发环境变量
.env.production     → 生产环境变量
```

### 2. 优化清单

- [ ] 代码分割(vendor chunks)
- [ ] Tree-shaking(ES6 modules)
- [ ] Gzip压缩
- [ ] 图片压缩
- [ ] 删除console.log
- [ ] 使用esbuild压缩

### 3. 构建命令

```bash
# 开发
pnpm dev          # 启动开发服务器

# 构建
pnpm build        # 生产构建
pnpm preview      # 预览生产构建

# 分析
pnpm build --report  # 生成打包分析报告
```

### 4. 下一章预告

第15章将深入核心组件与交互:

1. ChatMessage组件实现(用户/AI消息气泡)
2. Markdown渲染组件(marked + highlight.js)
3. CodeBlock代码块组件(语法高亮 + 复制按钮)
4. InputArea输入框组件(自动高度 + 快捷键)
5. 历史记录侧边栏组件

---

**思考题**:

1. 为什么axios要放在dependencies而不是devDependencies?
2. `^3.5.13`和`~3.5.13`在实际安装时有什么区别?
3. Tree-shaking为什么只对ES6模块有效,对CommonJS无效?
